from rich.console import Console
from rich.prompt import Prompt
from rich.text import Text
import sys
from prompt_toolkit import PromptSession
from prompt_toolkit import print_formatted_text
from prompt_toolkit.formatted_text import FormattedText

class UserInputAgent:
    """
    Agent to handle user input.
    """
    def __init__(self):
        self.console = Console()
        self.input_history = []

    def get_last_task(self):
        """
        Get the last task from user input history.
        """
        if self.input_history:
            return self.input_history[-1]
        else:
            return None

    def get_task(self):
        """
        Get the task from user input using prompt_toolkit for advanced input handling.
        """
        session = PromptSession()

        try:
            if len(self.input_history) == 0:
                prompt_text = FormattedText([
                    ("bold blue", "Enter your task (multiple lines allowed).\n"),
                    ("", "Type "),
                    ("bold green", "'done'"),
                    ("", " to finish, "),
                    ("bold yellow", "'cancel'"),
                    ("", " to restart, "),
                    ("bold red", "'exit'"),
                    ("", " to exit:\n"),
                    ("magenta", "────────────────────────────────────────────────────────────────\n")
                ])
            else:
                prompt_text = FormattedText([
                    ("bold blue", "Enter your task (multiple lines allowed).\n"),
                    ("", "Type "),
                    ("bold green", "'done'"),
                    ("", " to finish, "),
                    ("bold yellow", "'cancel'"),
                    ("", " to restart, or "),
                    ("bold red", "'exit'"),
                    ("", " to exit, "),
                    ("bold blue", "'repeat'"),
                    ("", " to repeat the previous task:\n"),
                    ("magenta", "────────────────────────────────────────────────────────────────\n")
                ])
            print_formatted_text(prompt_text)

            lines = []
            while True:
                line = session.prompt("")
                if line.strip().lower() == 'done':
                    print_formatted_text(FormattedText([("bold green", "Saving input...")]))
                    self.input_history.append("\n".join(lines))
                    break
                elif line.strip().lower() == 'cancel':
                    print_formatted_text(FormattedText([("bold yellow", "Input cancelled. Restarting input.")]))
                    return self.get_task()
                elif line.strip().lower() == 'exit':
                    print_formatted_text(FormattedText([("bold red", "Exiting application.")]))
                    sys.exit()
                elif line.strip().lower() == 'repeat' and len(self.input_history) > 0:
                    print_formatted_text(FormattedText([("bold blue", "Repeating previous task...")]))
                    return self.input_history[-1]
                else:
                    lines.append(line)
            
            return "\n".join(lines)
        except KeyboardInterrupt:
            if lines:
                print_formatted_text(FormattedText([("bold yellow", "\nInput cancelled. Restarting input.")]))
                return self.get_task()
            else:
                print_formatted_text(FormattedText([("bold red", "\nNo input given. Exiting application.")]))
                sys.exit()
        except Exception as e:
            print_formatted_text(FormattedText([("bold red", f"Error occurred while getting user input: {e}")]))
            return None